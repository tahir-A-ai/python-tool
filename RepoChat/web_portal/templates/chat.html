{% extends 'base.html' %}

{% block content %}

<style>
    .chat-container {
        height: 65vh; /* Takes up 65% of the screen height */
        overflow-y: auto;
        background-color: #ffffff;
    }
    .message {
        max-width: 75%;
        padding: 12px 16px;
        margin-bottom: 12px;
        border-radius: 15px;
        position: relative;
        word-wrap: break-word;
    }
    /* User Message: Blue, Right Aligned */
    .message.user {
        background-color: #0d6efd; /* Bootstrap Primary Blue */
        color: white;
        margin-left: auto; /* Pushes it to the right */
        border-bottom-right-radius: 2px;
    }
    /* AI Message: Grey, Left Aligned */
    .message.ai {
        background-color: #f1f3f5; /* Light Grey */
        color: #212529;
        margin-right: auto; /* Pushes it to the left */
        border-bottom-left-radius: 2px;
    }
    .loading {
        font-style: italic;
        color: #6c757d;
        font-size: 0.9em;
        background: transparent !important;
        padding: 0;
    }
</style>

<div class="row justify-content-center">
    <div class="col-lg-10">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">ü§ñ Chatting with: <span class="text-primary">{{ repo.name }}</span></h4>
            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-sm">‚Üê Back to Dashboard</a>
        </div>

        <div class="card shadow-sm">
            <div class="card-body chat-container" id="chatBox">
                <div class="message ai">
                    Hello! I have analyzed the code for <strong>{{ repo.name }}</strong>. Ask me anything!
                </div>
            </div>
            
            <div class="card-footer bg-white p-3">
                <div class="input-group">
                    <input type="text" id="userInput" class="form-control" placeholder="Ask a question about your code..." onkeypress="handleEnter(event)">
                    <button class="btn btn-primary px-4" onclick="sendMessage()">
                        Send üöÄ
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    async function sendMessage() {
        const input = document.getElementById('userInput');
        const chatBox = document.getElementById('chatBox');
        const query = input.value.trim();

        if (!query) return;

        // 1. Add User Message to Screen
        chatBox.innerHTML += `<div class="message user">${escapeHtml(query)}</div>`;
        input.value = '';
        
        // Scroll to bottom
        scrollToBottom();

        // Show Loading...
        const loadingId = 'loading-' + Date.now();
        chatBox.innerHTML += `<div class="message ai loading" id="${loadingId}">Thinking...</div>`;
        scrollToBottom();

        try {
            // 2. Send to Django Backend
            const response = await fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ query: query })
            });

            const data = await response.json();
            
            // 3. Replace "Thinking..." with AI Answer
            document.getElementById(loadingId).remove();
            
            if (data.response) {
                // We use a helper to render newlines as <br> for better formatting
                const formattedResponse = escapeHtml(data.response).replace(/\n/g, '<br>');
                chatBox.innerHTML += `<div class="message ai">${formattedResponse}</div>`;
            } else {
                chatBox.innerHTML += `<div class="message ai text-danger">Error: ${data.error || 'Unknown error'}</div>`;
            }

        } catch (err) {
            const loadingElem = document.getElementById(loadingId);
            if (loadingElem) loadingElem.remove();
            chatBox.innerHTML += `<div class="message ai text-danger">Network Error. Please try again.</div>`;
        }
        
        scrollToBottom();
    }

    // Helper: Scroll to bottom of chat
    function scrollToBottom() {
        const chatBox = document.getElementById('chatBox');
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Helper: Prevent HTML injection (Basic Security)
    function escapeHtml(text) {
        if (!text) return text;
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Helper: Handle Enter key
    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }

    // Helper: Get CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

{% endblock %}